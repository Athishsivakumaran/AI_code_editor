<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Local IDE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles are unchanged */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .tab.active { background-color: #1e293b; color: #e2e8f0; border-bottom: 2px solid #4f46e5; }
        .tab { border-bottom: 2px solid transparent; }
    </style>
</head>
<body class="bg-slate-800 text-slate-300 font-sans">

    <div class="h-screen flex flex-col">
        <header class="bg-slate-900 p-2 flex items-center justify-between shadow-lg shrink-0 z-10">
            <h1 class="text-lg font-semibold text-white ml-2">My IDE</h1>
            <button id="run-button" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-1 px-3 rounded-md text-sm transition-colors mr-2">Run Code</button>
        </header>

        <div class="flex flex-grow overflow-hidden">
            <aside class="w-64 bg-slate-800 p-4 shrink-0 overflow-y-auto border-r border-slate-700 flex flex-col">
                <div class="flex items-center justify-between mb-4">
                     <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Explorer</h2>
                </div>
                 <!-- The "Open Folder" button replaces the dropdown -->
                <button id="open-folder-btn" class="w-full bg-slate-700 hover:bg-slate-600 border border-slate-600 rounded-md p-2 text-sm mb-4 transition-colors">
                    Open Folder
                </button>
                <div id="folder-name" class="text-xs text-slate-400 mb-2 truncate">No folder selected.</div>
                <ul id="file-list" class="space-y-1 flex-grow"></ul>
            </aside>

            <div class="flex-grow flex flex-col bg-slate-900">
                <div id="tab-bar" class="flex bg-slate-800 shadow-sm shrink-0">
                     <div id="empty-tab-message" class="p-3 text-slate-400 text-sm">Open a folder and select a file to begin.</div>
                </div>
                <main id="editor-container" class="flex-grow relative"></main>
                <footer class="bg-black/20 h-48 p-2 shrink-0 border-t-2 border-slate-700 flex flex-col">
                    <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 px-2">Terminal</h2>
                    <div id="output-content" class="flex-grow overflow-y-auto font-mono text-xs text-slate-300 px-2">
                        <p>> Terminal ready.</p>
                    </div>
                </footer>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs/loader.js"></script>
    <script>
        // --- STATE ---
        let currentFolderPath = null;
        let files = {};
        let openTabs = [];
        let activeTab = null; 
        let editor;

        // --- DOM ELEMENT REFERENCES ---
        const fileListEl = document.getElementById('file-list');
        const tabBarEl = document.getElementById('tab-bar');
        const emptyTabMessageEl = document.getElementById('empty-tab-message');
        const outputContentEl = document.getElementById('output-content');
        const runButton = document.getElementById('run-button');
        const editorContainer = document.getElementById('editor-container');
        const openFolderBtn = document.getElementById('open-folder-btn');
        const folderNameEl = document.getElementById('folder-name');
        
        // --- MONACO EDITOR INITIALIZATION ---
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs' }});
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(editorContainer, {
                value: "// Click 'Open Folder' to start coding",
                theme: 'vs-dark',
                automaticLayout: true,
                readOnly: true
            });
            initialize();
        });

        // --- FUNCTIONS ---
        
        function getLanguage(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            switch (ext) {
                case 'js': return 'javascript';
                case 'html': return 'html';
                case 'css': return 'css';
                case 'json': return 'json';
                case 'md': return 'markdown';
                default: return 'plaintext';
            }
        }

        function renderFileList() {
            fileListEl.innerHTML = ''; 
            for (const filename in files) {
                const li = document.createElement('li');
                li.className = 'text-slate-300 hover:bg-slate-700 rounded-md p-2 cursor-pointer transition-colors text-sm';
                li.textContent = filename;
                li.setAttribute('data-filename', filename);
                li.addEventListener('click', () => openFile(filename));
                fileListEl.appendChild(li);
            }
        }

        function renderTabs() { /* Unchanged from previous version */ 
            tabBarEl.innerHTML = '';
            if (openTabs.length === 0) {
                 tabBarEl.appendChild(emptyTabMessageEl);
                 emptyTabMessageEl.style.display = 'block';
                 return;
            }
            emptyTabMessageEl.style.display = 'none';

            openTabs.forEach(filename => {
                const tab = document.createElement('div');
                tab.className = 'tab flex items-center p-2 cursor-pointer border-r border-slate-700 bg-slate-900 hover:bg-slate-700';
                if (filename === activeTab) tab.classList.add('active');

                const label = document.createElement('span');
                label.textContent = filename;
                label.className = 'text-sm mr-2';
                tab.appendChild(label);

                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '&times;';
                closeBtn.className = 'text-md leading-none hover:bg-slate-600 rounded-full w-5 h-5 flex items-center justify-center transition-colors';
                closeBtn.onclick = (e) => { e.stopPropagation(); closeFile(filename); };
                tab.appendChild(closeBtn);
                
                tab.onclick = () => switchTab(filename);
                tabBarEl.appendChild(tab);
            });
        }
        
        async function openFile(filename) {
            if (!openTabs.includes(filename)) {
                openTabs.push(filename);
            }
            // If the file content hasn't been loaded yet, fetch it now.
            if (!files[filename].content) {
                const fullPath = await window.electronAPI.joinPath(currentFolderPath, filename);
                const content = await window.electronAPI.readFile(fullPath);
                files[filename].content = content || `// Could not load content for ${filename}`;
            }
            switchTab(filename);
        }

        function closeFile(filename) { /* Unchanged from previous version */ 
            const index = openTabs.indexOf(filename);
            if (index > -1) {
                openTabs.splice(index, 1);
                if (files[filename].model) {
                    files[filename].model.dispose();
                    files[filename].model = null;
                }
                if (activeTab === filename) {
                    const newActiveTab = openTabs.length > 0 ? openTabs[openTabs.length - 1] : null;
                    switchTab(newActiveTab);
                }
                renderTabs();
            }
        }
        
        function switchTab(filename) {
            if (activeTab && files[activeTab]) {
                files[activeTab].viewState = editor.saveViewState();
            }
            activeTab = filename;
            if (filename === null) {
                editor.setValue("// Select a file to start coding");
                editor.updateOptions({ readOnly: true });
                editor.setModel(null);
            } else {
                editor.updateOptions({ readOnly: false });
                const file = files[filename];
                if (!file.model) {
                    file.model = monaco.editor.createModel(file.content, file.language);
                    file.model.onDidChangeContent(() => {
                        file.content = file.model.getValue();
                    });
                }
                editor.setModel(file.model);
                if (file.viewState) {
                    editor.restoreViewState(file.viewState);
                }
                editor.focus();
            }
            renderTabs();
        }
        
        function runCode() { /* Unchanged from previous version */ 
            outputContentEl.innerHTML += `<p>> Running ${activeTab || 'nothing'}...</p>`;
            if (activeTab && files[activeTab]) {
                const content = files[activeTab].content;
                const output = `> Output for ${activeTab}:\n//-----\n${content}\n//-----\n> Execution finished.`;
                const p = document.createElement('p');
                p.innerText = output;
                p.className = "whitespace-pre-wrap";
                outputContentEl.appendChild(p);
                outputContentEl.scrollTop = outputContentEl.scrollHeight;
            } else {
                 outputContentEl.innerHTML += `<p class="text-red-400">> No active file to run.</p>`;
            }
        }

        // --- INITIALIZATION & EVENT LISTENERS ---
        function initialize() {
            runButton.addEventListener('click', runCode);

            // The main event listener for the "Open Folder" button.
            openFolderBtn.addEventListener('click', async () => {
                const folderData = await window.electronAPI.openFolder();
                if (folderData) {
                    currentFolderPath = folderData.path;
                    // Update the UI with the folder name
                    folderNameEl.textContent = currentFolderPath.split(path.sep).pop();

                    // Reset state
                    files = {};
                    openTabs = [];
                    switchTab(null);
                    
                    // Populate the new file list
                    folderData.files.forEach(filename => {
                        files[filename] = {
                            language: getLanguage(filename),
                            content: null // Content will be lazy-loaded on click
                        };
                    });
                    renderFileList();
                }
            });
        }
    </script>
</body>
</html>
